<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒ¸ è–¬ãƒãƒ ğŸŒ¸</title>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Zen Maru Gothic', sans-serif; text-align: center; background: #fff5f7; margin: 0; padding: 20px; color: #5d5d5d; }
        .container { max-width: 400px; margin: auto; }
        h1 { color: #ff8fb1; font-size: 1.8rem; margin-bottom: 10px; }
        .status-msg { font-size: 1.1rem; color: #ffb7c5; font-weight: bold; margin-bottom: 20px; min-height: 1.5em; }
        .card { background: white; padding: 12px; border-radius: 20px; box-shadow: 0 8px 15px rgba(255, 143, 177, 0.1); margin-bottom: 12px; border: 2px solid #ffe4e9; }
        .btn { width: 100%; font-size: 18px; padding: 18px; color: white; border: none; border-radius: 15px; cursor: pointer; font-weight: 700; touch-action: manipulation; transition: 0.3s; }
        .btn.sub { background: #ffb7c5; margin-top: 20px; font-size: 14px; padding: 10px; }
        #history-page { display: none; }
        .history-card { background: white; margin-bottom: 15px; padding: 15px; border-radius: 20px; text-align: left; border-left: 8px solid #ffb7c5; box-shadow: 0 4px 10px rgba(255,183,197,0.2); }
        .history-date { font-weight: bold; color: #ff8fb1; border-bottom: 1px solid #ffe4e9; margin-bottom: 8px; padding-bottom: 3px; }
    </style>
</head>
<body>

<div id="main-page" class="container">
    <h1>ğŸŒ¸ è–¬ãƒãƒ ğŸŒ¸</h1>
    <div id="status-msg" class="status-msg">ãã‚‡ã†ã‚‚ ã¼ã¡ã¼ã¡ ã®ã‚‚ã†ã­</div>
    <div id="medicine-list"></div>
    <button class="btn sub" onclick="showHistory()">ğŸ“… 1é€±é–“ã®ãã‚ãã‚’è¦‹ã‚‹</button>
</div>

<div id="history-page" class="container">
    <h1>ğŸ“… 1é€±é–“ã®ãã‚ã</h1>
    <div id="history-list"></div>
    <button class="btn" style="background:#ffb7c5; margin-top:20px;" onclick="showMain()">âœ¨ ãƒ¡ã‚¤ãƒ³ã«ã‚‚ã©ã‚‹</button>
</div>

<script>
    const MEDICINES = ["ã‚³ãƒ³ã‚µ1", "ã‚³ãƒ³ã‚µ2", "æŠ‘è‚æ•£", "é “æœ"];
    let db;

    // --- 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æº–å‚™ ---
    const request = indexedDB.open("YakumaneDB", 1);
    request.onupgradeneeded = (e) => {
        db = e.target.result;
        db.createObjectStore("logs", { keyPath: "id", autoIncrement: true });
    };
    request.onsuccess = (e) => {
        db = e.target.result;
        render();
    };

    // --- 2. è¨˜éŒ² ---
    function record(name) {
        const now = new Date();
        const date = now.toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit' }).replaceAll('-', '/');
        const time = now.toLocaleTimeString('ja-JP', { hour12: false });
        const transaction = db.transaction(["logs"], "readwrite");
        transaction.objectStore("logs").add({ name, date, time, timestamp: now.getTime() });
        transaction.oncomplete = () => render();
    }

    // --- 3. å‰Šé™¤ ---
    function deleteRecent(name) {
        const today = new Date().toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit' }).replaceAll('-', '/');
        const transaction = db.transaction(["logs"], "readwrite");
        const store = transaction.objectStore("logs");
        store.openCursor(null, "prev").onsuccess = (e) => {
            const cursor = e.target.result;
            if (cursor) {
                if (cursor.value.name === name && cursor.value.date === today) {
                    if (confirm(name + " ã®ãã‚ãã‚’ã‘ã™ï¼Ÿ")) {
                        cursor.delete();
                        render();
                    }
                    return;
                }
                cursor.continue();
            }
        };
    }

    // --- 4. ç”»é¢ã®æç”» ---
    async function render() {
        const logs = await getAllLogs();
        const today = new Date().toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit' }).replaceAll('-', '/');
        const todayLogs = logs.filter(l => l.date === today);
        const takenNames = todayLogs.map(l => l.name);
        
        // å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        const allClear = MEDICINES.slice(0, 3).every(m => takenNames.includes(m));
        document.getElementById("status-msg").innerHTML = allClear ? "<div style='color:#ff6b81;'>ğŸ’– å…¨å®Œäº†ï¼ ğŸ’–</div>" : "ãã‚‡ã†ã‚‚ ã¼ã¡ã¼ã¡ ã®ã‚‚ã†ã­";

        // é “æœã®å¾…ã¡æ™‚é–“
        let tonpukuWait = "";
        let canTonpuku = true;
        const tonpukuLogs = logs.filter(l => l.name === "é “æœ");
        if (tonpukuLogs.length > 0) {
            const lastT = tonpukuLogs[tonpukuLogs.length - 1].timestamp;
            const diffMs = (new Date().getTime()) - lastT;
            const waitMs = 4 * 60 * 60 * 1000;
            if (diffMs < waitMs) {
                canTonpuku = false;
                const rem = waitMs - diffMs;
                const h = Math.floor(rem / 3600000);
                const m = Math.floor((rem % 3600000) / 60000);
                tonpukuWait = `(ã‚ã¨${h}h${m}m)`;
            }
        }

        const listDiv = document.getElementById("medicine-list");
        listDiv.innerHTML = "";
        
        MEDICINES.forEach(m => {
            const isTaken = (m !== "é “æœ" && takenNames.includes(m));
            let bgColor = "#87ceeb";
            if (isTaken) bgColor = "#e0e0e0";
            else if (m === "é “æœ") bgColor = canTonpuku ? "#ff8fb1" : "#f3d1d9";

            const card = document.createElement("div");
            card.className = "card";
            const btn = document.createElement("button");
            btn.className = "btn";
            btn.style.background = bgColor;
            btn.innerText = `${m}${isTaken ? " (æ¸ˆ)" : ""}${m === "é “æœ" && !canTonpuku ? " " + tonpukuWait : ""}`;
            
            let timer;
            btn.onmousedown = () => { timer = setTimeout(() => deleteRecent(m), 800); };
            btn.ontouchstart = () => { timer = setTimeout(() => deleteRecent(m), 800); };
            btn.onmouseup = () => clearTimeout(timer);
            btn.ontouchend = () => clearTimeout(timer);
            btn.onclick = () => { if (!isTaken && (m !== "é “æœ" || canTonpuku)) record(m); };

            card.appendChild(btn);
            listDiv.appendChild(card);
        });
    }

    // --- 5. å±¥æ­´è¡¨ç¤º ---
    async function showHistory() {
        document.getElementById("main-page").style.display = "none";
        document.getElementById("history-page").style.display = "block";
        const logs = await getAllLogs();
        const listDiv = document.getElementById("history-list");
        listDiv.innerHTML = "";
        for (let i = 0; i < 7; i++) {
            const d = new Date();
            d.setDate(d.getDate() - i);
            const ds = d.toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit' }).replaceAll('-', '/');
            const dayLogs = logs.filter(l => l.date === ds);
            let html = `<div class="history-card"><div class="history-date">${ds}</div>`;
            if (dayLogs.length === 0) html += `<div style="color:#ccc;">ãã‚ããªã—</div>`;
            else dayLogs.forEach(l => html += `<div style="margin:5px 0; color:#666;">ãƒ»${l.time} ${l.name}</div>`);
            html += `</div>`;
            listDiv.innerHTML += html;
        }
    }

    function showMain() {
        document.getElementById("main-page").style.display = "block";
        document.getElementById("history-page").style.display = "none";
    }

    function getAllLogs() {
        return new Promise((resolve) => {
            if(!db) return resolve([]);
            const transaction = db.transaction(["logs"], "readonly");
            const store = transaction.objectStore("logs");
            const req = store.getAll();
            req.onsuccess = () => resolve(req.result);
        });
    }

    setInterval(render, 60000);
</script>
</body>
</html>
